# Finish TurkEats UI - Implementation Plan

> **For Claude:** Execute this plan step-by-step to complete the UI demo. No Stripe integration needed.

**Goal:** Complete working checkout flow (address → payment → review → confirmation) with full error handling and French UX.

**Architecture:** React Native Expo + Zustand (existing state), mock API responses, graceful fallbacks for incomplete backend.

**Tech Stack:** React Native, Expo Router, NestJS mock backend, Zustand stores

---

## Current State Assessment

✅ **Complete:**
- Address selection (address.tsx)
- Delivery time picker (delivery-time.tsx)
- Payment method selection (payment.tsx) - fetches real backend, falls back to mock
- Order review (review.tsx) - calls real API endpoint with fallback
- Confirmation screen (confirmation.tsx) - animations, cashback display

⚠️ **Needs Work:**
- Error handling in review.tsx (incomplete error flow)
- Edge cases (empty cart, invalid inputs, network timeouts)
- French localization gaps
- Loading states during API call
- Retry logic for failed API calls

❌ **Missing:**
- None critical - all screens exist

---

## Phase 1: Fix Error Handling in review.tsx

**Files:**
- Modify: `apps/mobile/app/checkout/review.tsx:138-152`
- Test: Manual testing against mock backend

**Step 1: Improve error parsing in review.tsx**

The current error handling only works if backend returns JSON. If it returns HTML (500 error), it crashes.

Replace this:
```typescript
if (!response.ok) {
  const errorData = await response.json();
  throw new Error(errorData.message || `Erreur serveur: ${response.status}`);
}
```

With this:
```typescript
if (!response.ok) {
  let errorMessage = `Erreur serveur: ${response.status}`;
  try {
    const contentType = response.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
      const errorData = await response.json();
      errorMessage = errorData.message || errorMessage;
    }
  } catch (e) {
    // Content is not JSON, use status code message
  }
  throw new Error(errorMessage);
}
```

**Step 2: Add network timeout**

```typescript
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

try {
  const response = await fetch(`${apiUrl}/api/orders`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${mockAuthToken}`,
    },
    body: JSON.stringify(orderRequest),
    signal: controller.signal,
  });
  clearTimeout(timeoutId);
  // ... rest of code
} catch (error) {
  clearTimeout(timeoutId);
  if (error instanceof Error && error.name === 'AbortError') {
    throw new Error('Délai d\'attente dépassé. Veuillez réessayer.');
  }
  throw error;
}
```

**Step 3: Add retry logic for transient failures**

```typescript
async function makeOrderRequest(orderRequest, maxRetries = 2) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      // API call code here
      return response;
    } catch (error) {
      if (attempt < maxRetries && isTransientError(error)) {
        await new Promise(resolve => setTimeout(resolve, 1000 * attempt)); // exponential backoff
        continue;
      }
      throw error;
    }
  }
}

function isTransientError(error: unknown): boolean {
  if (error instanceof Error) {
    return error.name === 'AbortError' ||
           error.message.includes('network') ||
           error.message.includes('timeout');
  }
  return false;
}
```

**Step 4: Verify TypeScript compiles**

```bash
npm run build
```

Expected: No errors

---

## Phase 2: Add Loading + Error States to UI

**Files:**
- Modify: `apps/mobile/app/checkout/review.tsx` - entire screen

**Step 1: Show loading spinner during API call**

The screen already has `isProcessing` state. Make sure it's visible:

```typescript
if (isProcessing) {
  return (
    <View style={styles.loadingContainer}>
      <ActivityIndicator size="large" color="#FF6B35" />
      <Text style={styles.loadingText}>Traitement de votre commande...</Text>
    </View>
  );
}
```

**Step 2: Add retry button on error**

When `orderError` is called, show error with retry:

```typescript
if (checkoutState.error) {
  return (
    <View style={styles.errorContainer}>
      <FontAwesome name="exclamation-circle" size={48} color="#DC2626" />
      <Text style={styles.errorTitle}>Erreur</Text>
      <Text style={styles.errorMessage}>{checkoutState.error}</Text>
      <Pressable
        style={styles.retryButton}
        onPress={() => handlePlaceOrder()} // Retry
      >
        <Text style={styles.retryButtonText}>Réessayer</Text>
      </Pressable>
      <Pressable
        style={styles.cancelButton}
        onPress={() => router.back()} // Go back to review
      >
        <Text style={styles.cancelButtonText}>Annuler</Text>
      </Pressable>
    </View>
  );
}
```

**Step 3: Add timeout warning**

Show a message if API takes >5 seconds:

```typescript
const [isSlowApi, setIsSlowApi] = useState(false);

useEffect(() => {
  if (!isProcessing) return;
  const timer = setTimeout(() => setIsSlowApi(true), 5000);
  return () => clearTimeout(timer);
}, [isProcessing]);

// In render:
{isSlowApi && (
  <View style={styles.warningBanner}>
    <Text style={styles.warningText}>
      ⏳ Le serveur répond lentement. Veuillez patienter...
    </Text>
  </View>
)}
```

---

## Phase 3: Edge Cases

**Files:**
- Modify: `apps/mobile/app/checkout/review.tsx:81-96` (validation)

**Step 1: Validate cart not empty**

```typescript
if (cartState.items.length === 0) {
  throw new Error('Panier vide - veuillez ajouter des articles');
}
```

**Step 2: Validate delivery address has all required fields**

```typescript
const requiredFields = ['streetAddress', 'city', 'postalCode'];
for (const field of requiredFields) {
  if (!checkoutState.deliveryAddress[field]) {
    throw new Error(`Adresse incomplète: ${field} manquant`);
  }
}
```

**Step 3: Validate at least one item has quantity > 0**

```typescript
const hasItems = cartState.items.some(item => item.quantity > 0);
if (!hasItems) {
  throw new Error('Quantités invalides - ajoutez au moins un article');
}
```

---

## Phase 4: Polish & Testing

**Files:**
- All checkout screens

**Step 1: French localization audit**

Search for English text:
```bash
grep -r "Loading\|Processing\|Error\|Retry\|Cancel" apps/mobile/app/checkout/
```

Replace all with French equivalents:
- Loading → Chargement
- Processing → Traitement
- Error → Erreur
- Retry → Réessayer
- Cancel → Annuler
- Network error → Erreur réseau
- Timeout → Délai d'attente dépassé

**Step 2: Test against mock backend**

```bash
npm run dev  # Start mobile app
# Manually test:
# 1. Go through checkout flow
# 2. Verify API calls show in network tab
# 3. Test with valid data → should go to confirmation
# 4. Test with invalid data → should show errors
# 5. Test network timeout (disable API temporarily)
```

**Step 3: Visual polish**

- [ ] Button spacing consistent
- [ ] Error messages readable (red text with icon)
- [ ] Loading spinner visible and centered
- [ ] Confirmation screen animations smooth
- [ ] Cashback amount displays correctly
- [ ] All text properly French

---

## Verification Checklist

Before declaring "done":

- [ ] Order review screen shows all fees correctly
- [ ] API call is made when "Passer la commande" clicked
- [ ] Error message appears if order creation fails
- [ ] Retry button works and re-attempts API call
- [ ] Timeout shows after 30 seconds of waiting
- [ ] Confirmation screen appears on success
- [ ] Confirmation shows order number (from API response)
- [ ] Confirmation shows estimated delivery time
- [ ] Confirmation shows cashback amount
- [ ] "Suivre ma commande" button navigates correctly
- [ ] "Retour à l'accueil" button clears cart and returns home
- [ ] All French text is grammatically correct
- [ ] No console errors during checkout flow
- [ ] TypeScript compiles with 0 errors

---

## Success Criteria

✅ Complete checkout flow works end-to-end (address → payment → review → confirmation)
✅ All error cases handled gracefully with user-friendly French messages
✅ Loading states visible during API calls
✅ Retry logic for network failures
✅ Timeout after 30 seconds with user notification
✅ Confirmation screen shows order details from API
✅ Full French localization
✅ No console errors or crashes
✅ Ready for demo to stakeholders

---

## Estimated Time

- Error handling improvements: 2 hours
- Loading/error UI states: 2 hours
- Edge case validation: 1 hour
- French localization audit: 1 hour
- Manual testing & polish: 2-3 hours
- **Total: 8-9 hours** (can do in one session)

---

## After UI is Done

With a complete, working UI demo:
1. You'll have a visual checkpoint for quality
2. Easy to hand off to QA or stakeholders
3. Backend can be integrated later without UI changes
4. Remaining blockers (#2, #4, #7) can be done in parallel
5. Ready for realistic user testing
